# Infrastructure (Pulumi) deployment workflow.
# Runs preview on PR; manual dispatch for deploy. Requires PULUMI_ACCESS_TOKEN for Pulumi Cloud.
name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      stack:
        description: "Pulumi stack (e.g. dev, staging, prod)"
        required: true
        default: "dev"
      action:
        description: "Action"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - up
  pull_request:
    branches: [main]
    paths:
      - "infrastructure/**"
      - ".github/workflows/deploy-infra.yml"

env:
  AWS_REGION: us-east-1

jobs:
  preview:
    name: Pulumi Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'preview')
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: infrastructure/package-lock.json

      - name: Setup Pulumi
        uses: pulumi/actions@v5
        with:
          command: version
          version: latest

      - name: Install and preview
        working-directory: infrastructure
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          npm ci
          STACK="${{ github.event.inputs.stack || 'dev' }}"
          pulumi stack select $STACK --non-interactive || pulumi stack init $STACK --non-interactive
          npm run preview

  deploy:
    name: Pulumi Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'up'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: infrastructure/package-lock.json

      - name: Setup Pulumi
        uses: pulumi/actions@v5
        with:
          command: version
          version: latest

      - name: Deploy
        working-directory: infrastructure
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          npm ci
          STACK="${{ github.event.inputs.stack || 'dev' }}"
          pulumi stack select $STACK --non-interactive
          npm run deploy
